#!/usr/bin/env bash
#
# Get Bleach episodes from http://www.bleachget.com
#
# Invocation:
#  getbleach
#     Download episodes not found on the filesystem. Episodes found are not
#     checked for validity/completeness.
#  getbleach -e <episode>
#     Download the given episode. If the download of this episode was stopped
#     earlier, this will continue it.
#
# Optional arguments:
#  -o outdir
#    The directory where the downloaded episodes will be saved.
#    Defaults to ~/movies/bleach
#  -t thread_count
#    The number of episodes to download simultaneously (ignored when used with -e)
#    Defaults to 1

DIR=/home/`whoami`/movies/bleach
EP=""
THREAD_LIMIT=1

function usage {
    cat <<EOF
Invocation:
 getbleach
    Download episodes not found on the filesystem.
 getbleach -e <episode>
    Download the given episode. If the download of this episode was stopped
    earlier, this will continue it.

Optional arguments:
 -o outdir
   The directory where the downloaded episodes will be saved.
   Defaults to ~/movies/bleach
 -t thread_count
   The number of episodes to download simultaneously (ignored when used with -e)
   Defaults to 1
EOF
}

while getopts "ce:o:t:" optname
do
    case "$optname" in
        "e")
            # pad with 0-s from the left to 3 length (http://jonathanwagner.net/2007/04/zero-padding-in-bash/)
            EP=`printf "%03d" "$OPTARG"`
            ;;
        "o")
            if [ -d "$OPTARG" ]; then
                DIR="$OPTARG"
            else
                echo "Error: $OPTARG is not a directory"
                exit
            fi
            ;;
        "t")
            THREAD_LIMIT=$OPTARG
            ;;
        "?")
            usage
            exit
            ;;
    esac
done

#if [ -n -d "$DIR/raw" ]; then mkdir "$DIR/raw"; fi

if [ "$EP" = '' ]
then
    # Episode list from the index page
	echo 'Fetching episode list...'
	wget 'http://www.bleachget.com/' --output-document="$DIR/html" -q
	grep subbed "$DIR/html" | sed -e 's/<tr>/\n<tr>/g' | sed -e 's/^.*href="\([^"]*\)".*$/\1/g' | grep 'bleach-episode' | uniq > "$DIR/links"
	REMOTE=`sed -e 's~^.*episode-\([0-9]*\).*$~\1~g' "$DIR/links" | sort`

    # Downloaded episodes on the FS...
	echo 'Checking for downloaded episodes...'
	LOCAL=''
	for FILE in `ls "$DIR" | grep -E "\.flv$" | sed -e 's~$DIR/\([0-9].*\)\.flv~\1~'`
	do
		LOCAL=$LOCAL" $FILE"
	done
	rm "$DIR/html"

	# To download := {REMOTE}\{LOCAL}
	TODO=''
	for EP in $REMOTE
	do
		if [[ $LOCAL != *$EP* ]]; then
			TODO=$TODO" $EP"
		fi
	done
	echo 'Download list:'$TODO

    # and download, with given number of threads
    echo $TODO | xargs -d ' ' -n1 -P $THREAD_LIMIT -I {} getbleach-episode {} "$DIR"
else
	getbleach-episode $EP "$DIR"
fi

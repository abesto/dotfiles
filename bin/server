#!/bin/bash

. /etc/rc.conf
. /etc/rc.d/functions

DYNDNS=1  # Use DynDNS?
FIREHOL=1 # Use firehol?

case "$1" in
    start|restart)
        if [ $DYNDNS -eq 1 ]; then
            stat_busy "Updating DynDNS IP"
            dyndns.sh > /dev/null 2>&1
            stat_done #TODO: check if update was succesful
        fi
        if [ $FIREHOL -eq 1 ]; then
            stat_busy "Opening HTTP port"
            sed -e 's/^[ \t]*#[ \t]*server http accept/\	server http accept/' /etc/firehol/firehol.conf > /tmp/firehol.conf
            mv /tmp/firehol.conf /etc/firehol/firehol.conf
            /etc/rc.d/firehol start > /dev/null 2>&1
            stat_done
        fi
        ;;
    stop)
        if [ $DYNDNS -eq 1 ]; then
            stat_busy "Updating DynDNS IP to 127.0.0.1"
            dyndns.sh 127.0.0.1 > /dev/null 2>&1
            stat_done
        fi
        if [ $FIREHOL -eq 1 ]; then
            stat_busy "Closing HTTP port"
            sed -e 's/^[ \t]*server http accept/\	# server http accept/' /etc/firehol/firehol.conf > /tmp/firehol.conf
            mv /tmp/firehol.conf /etc/firehol/firehol.conf
            /etc/rc.d/firehol start > /dev/null 2>&1
            stat_done
        fi
        ;;
    *)
        echo "Usage: $0 {start|restart|stop}"
        exit 1;
        ;;
esac

/etc/rc.d/httpd $1
/etc/rc.d/mysqld $1

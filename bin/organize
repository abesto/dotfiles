#!/usr/bin/env sh
#
# Organize music in current dir and subdirs into
# 'A/Artist/Album/01. Track'  structure

ORGDIR="`pwd`/organized"
ALLDIR="`pwd`/alldir"

mkdir -p "$ORGDIR"
mkdir -p "$ALLDIR"

find . -iname '*.mp3' > all
I=0
while FILE="`line`"
do
  ln "$FILE" "$ALLDIR/$I"
  I=`expr $I + 1`
done < all

for FILE in "$ALLDIR/"*
do
    DIR=""
    ARTIST=""
    TITLE=""
    TRACK=""
    ALBUM=""
    NAME=""
    eval $(id3info "$FILE" | awk '
/=== TPE/ { sub(/"/, "\\\"", $0); printf ("ARTIST=\"%s\"\n", substr($0, 42, length($0)-1)); }
/=== TIT/ { sub(/"/, "\\\"", $0); printf ("TITLE=\"%s\"\n", substr($0, 48, length($0)-1)); }
/=== TRCK/ { sub(/"/, "\\\"", $0);printf ("TRACK=\"%s\"\n", substr($0, 42, length($0)-1)); }
/=== TALB/ { sub(/"/, "\\\"", $0);printf ("ALBUM=\"%s\"\n", substr($0, 35, length($0)-1)); }
')
    DIR=$ORGDIR/$(echo $ARTIST | cut -c -1)/$ARTIST/$(echo $ALBUM | sed 's/(^ *| *$)//g')
    if [[ $DIR =~ "//" ]]; then
        continue
    fi
    mkdir -p "$DIR"

    if [[ $TITLE = "" ]]; then
        NAME=`echo $FILE | sed "s/$1//"`
    else
        if [[ $TRACK != "" ]]; then
            NAME=$(echo "$TRACK. " | sed 's~/~of~')
        fi
        NAME=$NAME$TITLE.mp3
    fi
    NAME=$DIR/$NAME
    if [[ ! $NAME =~ "///" ]]; then
       ln "$FILE" "$NAME"
    fi
done

rm all
rm "$ALLDIR" -r
